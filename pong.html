<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>Canvas</title>
	
	<style type="text/css" media="screen">
	* { margin: 0; padding: 0; outline: 0; }
	html, body { background: black; text-align: center; color: #4da612; }
	h1 { background: url(pong.gif) no-repeat center 30px; height: 133px; font-size:0; line-height: 0; text-indent: -4000px; }
	a { color: white; text-decoration: none }
	canvas { border-top: 1px solid #4da612; border-bottom: 1px solid #4da612; cursor: crosshair; margin-top: 30px; }
	p { height: 22px; margin-top: 30px; background: url(footer.gif) no-repeat center 0; font-size:0; line-height: 0; text-indent: -4000px; }
	</style>
	
	<script src="ncanvas.js" type="text/javascript" language="javascript" charset="utf-8" ></script>
	<script src="ncanvas-text.js" type="text/javascript" language="javascript" charset="utf-8" ></script>
	<script type="text/javascript" language="javascript" charset="utf-8">
	
	function init() {
		var n = document.getElementById("area").getNCanvas();
		var score = 0;
		var hits = 0
		
		var board = new NText({x: 0, y:10, text: 'Score: 123', color: '#4da612', width: 15, height: 15, opacity: 0.8, visible: false});
		board.x = n.stage.width/2 - board.textWidth()/2;
		board.shadowOffsetX = 0;
		board.shadowOffsetY = 0;
		board.shadowBlur    = 8;
		board.shadowColor   = '#4da612';
		n.stage.addChild(board);
		
		var separator = new NRect({x: n.stage.width/2, y: 35, width: 1, height: n.stage.height - 35, fillColor: '#4da612'});
		n.stage.addChild(separator);
		
		var bar_pc = new NRect();
		var bar_pc_defaults = {width: 13, height: 60, x: 10, y: n.stage.height/2 - 30, fillColor: '#4da612', accY: 0, opacity: 1};
		bar_pc.set(bar_pc_defaults);
		n.stage.addChild(bar_pc);
		
		var keys = {up: false, down: false};
		window.onkeydown = function(e) {
			switch(e.keyCode){
				case 38: keys.up = true; break;
				case 40: keys.down = true; break;
			}
		}
		window.onkeyup = function(e) {
			switch(e.keyCode){
				case 38: keys.up = false; break;
				case 40: keys.down = false; break;
			}
		}
		
		var bar_player = new NRect({ny: n.stage.height/2 - 30});
		var bar_player_defaults = {width: 13, height: 60, x: n.stage.width - 23, y: n.stage.height/2 - 30, fillColor: '#4da612', opacity: 1};
		bar_player.set(bar_player_defaults);
		n.stage.addChild(bar_player);
		
		var ball = new NRect();
		var ball_defaults = {fillColor: '#4da612', width: 10, height: 10, x: n.stage.width/2, y: n.stage.height/2, accX: -6, accY: 0, accMax: 6, opacity: 1};
		ball.set(ball_defaults);
		n.stage.addChild(ball);
		
		var gameFrame = new NFrame({name: 'game'});
		n.addFrame(gameFrame);
		
		var loseFrame = new NFrame({name: 'loses'});
		n.addFrame(loseFrame);
		
		var startFrame = new NFrame({name: 'start'});
		n.addFrame(startFrame);
		
		n.goto(startFrame);
		
		var status = new NText({x: 0, y: n.stage.height/2 - 9, width: 20, height: 20, text: 'Click to start!', color: '#4da612'});
		status.x = n.stage.width/2 - status.textWidth()/2;
		n.stage.addChild(status);
		
		status.shadowOffsetX = 0;
		status.shadowOffsetY = 0;
		status.shadowBlur    = 8;
		status.shadowColor   = '#4da612';
		
		n.fps = 2;
		ball.visible = bar_pc.visible = bar_player.visible = separator.visible = false;
		startFrame.addListener('onEnterFrame', function(e) {
			status.opacity = 0.5 + (status.opacity<=0.5)*0.5;
		});
		
		loseFrame.addListener('onEnterFrame', function(e) {
			separator.opacity = (separator.opacity-0.04 < 0)?0:separator.opacity - 0.04;
			bar_pc.opacity = (bar_pc.opacity-0.04 < 0)?0:bar_pc.opacity - 0.04;
			bar_player.opacity = (bar_player.opacity-0.03 < 0)?0:bar_player.opacity - 0.03;
			ball.opacity = (ball.opacity-0.02 < 0)?0:ball.opacity - 0.02;
			if( ball.opacity <= 0 && bar_pc.opacity <= 0 && bar_player.opacity <= 0 && separator.opacity <= 0 ) {
				status.text = 'Play Again?';
				status.x = n.stage.width/2 - status.textWidth()/2;
				resetGame();
			}
		});
		
		n.node.canvas.onmouseup = function() {
			if ( n.currentFrame == 'start') {
				n.stop();
				status.visible = false;
				board.visible = true;
				score = hits = 0;
				board.text = 'score: 0';
				ball.visible = bar_pc.visible = bar_player.visible = separator.visible = true;
				n.goto(gameFrame);
				n.loop(50);
			}
		}
		
		function resetGame() {
			status.visible = true;
			ball.set(ball_defaults);
			bar_pc.set(bar_pc_defaults);
			bar_player.set(bar_player_defaults);
			separator.opacity = 1;
			ball.visible = bar_pc.visible = bar_player.visible = separator.visible = false;
			n.stop();
			n.clear();
			n.goto(startFrame);
			n.loop(2);
		}
		
		gameFrame.addListener('onEnterFrame', function(e) {
			// Position bar_player
			if(keys.up) bar_player.ny -= 10;
			if(keys.down) bar_player.ny += 10;
			if(bar_player.ny < 0) {
				bar_player.ny = 0
			} else if( bar_player.ny + bar_player.height > n.stage.height ) {
				bar_player.ny = n.stage.height - bar_player.height
			}
			bar_player.y = bar_player.ny;
			
			// Position bar_pc
			bar_pc.y += bar_pc.accY;
			if(bar_pc.y < 0) {
				bar_pc.y = 0
			} else if( bar_pc.y + bar_pc.height > n.stage.height ) {
				bar_pc.y = n.stage.height - bar_pc.height
			}
		
			// Position ball
			var newPosition = {y: ball.y + ball.accY, x: ball.x + ball.accX, width: ball.width, height: ball.height};
			
			if ( ball.x + ball.accX + ball.width >= bar_player.x && ball.intersects(bar_player)) {
				var coeffY = (((bar_player.y + bar_player.height/2) - (newPosition.y + newPosition.height/2)) / (bar_player.height/2))*(Math.PI/4);
				ball.x = bar_player.x - ball.width;
				ball.accY = -1*Math.sin(coeffY)*ball.accMax;
				ball.accX = -1*Math.cos(coeffY)*ball.accMax;
				if( ball.accMax < 14 ) {
					ball.accMax += 0.4;
				}
				hits ++;
				score += Math.ceil( hits * ((Math.PI/4 - Math.abs(coeffY))/(Math.PI/4)));
				board.text = 'score: ' + score;
				
				// Animate bar_pc
				var frames = Math.floor(Math.abs((ball.x - (bar_pc.x + bar_pc.width))/ball.accX));
				var endY = ball.y;
				var endAccY = ball.accY;
				for (var i=0; i < frames; i++) {
					if ( endY + ball.height + endAccY > e.canvas.stage.height ) {
						endY -= endAccY - (e.canvas.stage.height - endY - ball.height)
						endAccY *= -1
					} else if(endY + endAccY < 0) {
						endY -= endY + endAccY;
						endAccY *= -1;
					} else {
						endY += endAccY;
					}
				}
				bar_pc.accY = (endY - (bar_pc.y + bar_pc.height/2))/frames;
			} else if(ball.x > bar_player.x) {
				n.stop();
				n.clear();
				n.goto(loseFrame);
				n.loop(25);
			} else if( ball.x + ball.accX <= bar_pc.x + bar_pc.width && ball.intersects(bar_pc) ) {
				var coeffY = (((bar_pc.y + bar_pc.height/2) - (newPosition.y + newPosition.height/2)) / (bar_pc.height/2))*(Math.PI/4);
				ball.x = bar_pc.x + bar_pc.width;
				ball.accY = -1*Math.sin(coeffY)*ball.accMax;
				ball.accX = Math.cos(coeffY)*ball.accMax;
				
				var frames = Math.floor(Math.abs((ball.x + ball.width - bar_player.x)/ball.accX));
				bar_pc.accY = (e.canvas.stage.height/2 - bar_pc.height/2 - bar_pc.y)/frames;
			} else {
				ball.x += ball.accX;
			}
			
			if ( ball.y + ball.height + ball.accY > e.canvas.stage.height ) {
				ball.y -= ball.accY - (e.canvas.stage.height - ball.y - ball.height)
				ball.accY *= -1
			} else if(ball.y + ball.accY < 0) {
				ball.y -= ball.y + ball.accY;
				ball.accY *= -1;
			} else {
				ball.y += ball.accY;
			}
		});
		
		n.node.canvas.onmousemove = function(e) {
			bar_player.ny = e.clientY - e.target.offsetTop - bar_player.height/2
		}
		
		n.iter();
		n.loop();
	}
	</script>
</head>
<body onload="init();"><h1>PONG</h1><canvas id="area" width="400" height="300">You are so not 2010!</canvas><p>By Siyan Panayotov</p></body>
</html>
